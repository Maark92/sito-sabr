<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onicotecnica Sabrina</title>
    <!-- Percorsi aggiornati -->
    <link rel="stylesheet" href="./css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="module" src="./js/supabaseClient.js"></script>
</head>
<body>
    <header class="site-header">
        <h1><i class="fas fa-hand-sparkles"></i> Benvenuti da Sabrina</h1>
        <button class="menu-toggle" aria-label="Menu">
            <i class="fas fa-bars"></i>
        </button>
        <nav>
            <ul>
                <li><a href="#servizi"><i class="fas fa-concierge-bell"></i> Servizi</a></li>
                <li><a href="#galleria"><i class="fas fa-images"></i> Galleria</a></li>
                <li><a href="#prenotazioni"><i class="fas fa-calendar-alt"></i> Prenotazioni</a></li>
                <li><a href="./dashboard.html"><i class="fas fa-user-cog"></i> Dashboard</a></li>
            </ul>
        </nav>
    </header>

    <section id="servizi" class="section">
        <h2>I nostri servizi</h2>
        <div class="services-container servizi-container">
            <!-- Trattamenti caricati dinamicamente -->
        </div>
    </section>

    <section id="galleria" class="section">
        <h2>Galleria</h2>
        <p>Foto dei nostri lavori.</p>
        <div class="galleria-container">
            <img src="./images/gallery1.jpg" alt="Galleria 1">
            <img src="./images/gallery2.jpg" alt="Galleria 2">
            <img src="./images/gallery3.jpg" alt="Galleria 3">
        </div>
    </section>

    <section id="prenotazioni" class="section">
        <h2><i class="fas fa-calendar-check"></i> Prenota un trattamento</h2>
        <form id="booking-form" class="booking-form">
            <label for="name">Nome:</label>
            <input type="text" id="name" name="name" required>
            <label for="phone">Telefono:</label>
            <input type="tel" id="phone" name="phone" required>
            <label for="date">Data:</label>
            <select id="date" name="date" required></select>
            <label for="time">Orario:</label>
            <select id="time" name="time" required>
                <option value="" disabled selected>Seleziona una data prima</option>
            </select>
            <label for="notes">Note:</label>
            <textarea id="notes" name="notes" rows="3" placeholder="Scrivi eventuali richieste o note..."></textarea>
            <button type="submit"><i class="fas fa-check-circle"></i> Prenota</button>
        </form>
        <p id="booking-message"></p>
    </section>

    <footer class="site-footer">
        <p>&copy; 2023 Sabrina Onicotecnica. Tutti i diritti riservati.</p>
    </footer>

    <script type="module">
        import { supabase } from './js/supabaseClient.js';

        // Funzione per caricare le date disponibili
        const loadDates = async () => {
            try {
                const { data: availability, error } = await supabase
                    .from('availability')
                    .select('date');

                if (error) {
                    console.error('Errore nel caricamento delle date:', error);
                    return;
                }

                const uniqueDates = [...new Set(availability.map(item => item.date))];
                const dateSelect = document.getElementById('date');
                if (dateSelect) {
                    dateSelect.innerHTML = uniqueDates.map(date => `
                        <option value="${date}">${date}</option>
                    `).join('');
                }
            } catch (err) {
                console.error('Errore imprevisto durante il caricamento delle date:', err);
            }
        };

        // Funzione per caricare gli orari disponibili per una data selezionata
        const loadTimesForDate = async (selectedDate) => {
            try {
                const { data: availability, error: availabilityError } = await supabase
                    .from('availability')
                    .select('time')
                    .eq('date', selectedDate);

                if (availabilityError) {
                    console.error('Errore nel caricamento degli orari disponibili:', availabilityError);
                    return;
                }

                const { data: bookedAppointments, error: appointmentsError } = await supabase
                    .from('appointments')
                    .select('time')
                    .eq('date', selectedDate);

                if (appointmentsError) {
                    console.error('Errore nel caricamento degli appuntamenti:', appointmentsError);
                    return;
                }

                const bookedTimes = bookedAppointments.map(appointment => appointment.time);
                const filteredTimes = availability.filter(item => !bookedTimes.includes(item.time));

                const timeSelect = document.getElementById('time');
                if (timeSelect) {
                    timeSelect.innerHTML = filteredTimes.map(item => `
                        <option value="${item.time}">${item.time}</option>
                    `).join('');
                    timeSelect.disabled = false;
                }
            } catch (err) {
                console.error('Errore imprevisto durante il caricamento degli orari:', err);
            }
        };

        // Aggiungi un listener per aggiornare gli orari quando cambia la data
        const dateSelect = document.getElementById('date');
        if (dateSelect) {
            dateSelect.addEventListener('change', async (event) => {
                const selectedDate = event.target.value;
                await loadTimesForDate(selectedDate);
            });
        }

        // Funzione per gestire la prenotazione
        const bookingForm = document.getElementById('booking-form');
        if (bookingForm) {
            bookingForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const client_name = document.getElementById('name').value;
                const phone = document.getElementById('phone').value;
                const date = document.getElementById('date').value;
                const time = document.getElementById('time').value;
                const notes = document.getElementById('notes').value;

                try {
                    const { error } = await supabase
                        .from('appointments')
                        .insert([{ client_name, phone, date, time, notes }]);

                    if (error) {
                        console.error('Errore durante la prenotazione:', error);
                        document.getElementById('booking-message').textContent = 'Errore durante la prenotazione. Riprova.';
                        return;
                    }

                    bookingForm.reset();
                    document.getElementById('booking-message').textContent = 'Prenotazione effettuata con successo!';
                    await loadDates();
                    await loadTimesForDate(date);
                } catch (err) {
                    console.error('Errore imprevisto durante la prenotazione:', err);
                    document.getElementById('booking-message').textContent = 'Errore imprevisto. Riprova.';
                }
            });
        }

        // Funzione per caricare i trattamenti
        async function loadTreatments() {
            try {
                const { data: treatments, error } = await supabase
                    .from('treatments')
                    .select('*')
                    .order('id', { ascending: true });

                if (error) {
                    console.error('Errore nel caricamento dei trattamenti:', error);
                    return;
                }

                const servicesContainer = document.querySelector('.services-container, .servizi-container');
                if (servicesContainer && treatments) {
                    // Raggruppa i trattamenti per categoria
                    const categories = {
                        'Manicure': treatments.filter(t => t.name.toLowerCase().includes('manicure')),
                        'Pedicure': treatments.filter(t => t.name.toLowerCase().includes('pedicure')),
                        'Ricostruzione': treatments.filter(t => t.name.toLowerCase().includes('ricostruzione')),
                        'Altri Servizi': treatments.filter(t => 
                            !t.name.toLowerCase().includes('manicure') && 
                            !t.name.toLowerCase().includes('pedicure') && 
                            !t.name.toLowerCase().includes('ricostruzione')
                        )
                    };

                    servicesContainer.innerHTML = Object.entries(categories)
                        .filter(([_, items]) => items.length > 0) // Mostra solo categorie non vuote
                        .map(([category, items]) => `
                            <div class="services-category">
                                <h3>${category}</h3>
                                <div class="service-grid">
                                    ${items.map(treatment => `
                                        <div class="service-card">
                                            <img src="${treatment.image_url}" alt="${treatment.name}">
                                            <h3>${treatment.name}</h3>
                                            <p>${treatment.description}</p>
                                            <p class="price">â‚¬${treatment.price.toFixed(2)}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('');
                }
            } catch (err) {
                console.error('Errore imprevisto:', err);
            }
        }

        // Carica i dati iniziali
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDates();
            await loadTreatments();
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Recupera l'URL dello sfondo da localStorage
                const backgroundImageURL = localStorage.getItem('backgroundImageURL');

                if (backgroundImageURL) {
                    // Applica l'immagine di sfondo dinamicamente
                    document.body.style.backgroundImage = `url('${backgroundImageURL}')`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                } else {
                    console.warn('Nessun URL dello sfondo trovato in localStorage.');
                }
            } catch (error) {
                console.error('Errore nel caricamento dello sfondo:', error);
            }
        });

        // Aggiungi alla fine del file
        document.querySelector('.menu-toggle').addEventListener('click', () => {
            document.querySelector('nav ul').classList.toggle('active');
        });

        // Chiudi menu quando si clicca un link
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', () => {
                document.querySelector('nav ul').classList.remove('active');
            });
        });
    </script>
</body>
</html>
