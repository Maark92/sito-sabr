<!DOCTYPE html>
<html lang="it">
<head>
 <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - Sabrina Onicotecnica</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script type="module" src="./js/supabaseClient.js"></script>
    <script type="module" src="./js/protect-dashboard.js"></script> <!-- <<< QUI, PRIMA DI ALTRI SCRIPT DELLA DASHBOARD -->
    <!-- Altri script o stili -->
</head>
<body>
    <header class="dashboard-header">
        <h1>Dashboard</h1>
        <div class="header-buttons">
            <button id="home-button" onclick="location.href='./'">Torna alla Home</button>
            <button id="logout-button">Logout</button>
        </div>
    </header>

    <nav class="dashboard-tabs">
        <button class="tab-button active" data-tab="clienti">Clienti</button>
        <button class="tab-button" data-tab="appuntamenti">Appuntamenti</button>
        <button class="tab-button" data-tab="trattamenti">Trattamenti</button>
        <button class="tab-button" data-tab="background-section">Sfondo</button>
        <button class="tab-button" data-tab="gallery-section">Galleria</button>
        <button class="tab-button" data-tab="disponibilita-section">Disponibilità</button>
    </nav>

    <main class="dashboard-content">
        <!-- Gestione Clienti -->
        <section id="clienti" class="tab-content active">
            <h2>Gestione Clienti</h2>
            <form id="add-client-form" class="dashboard-form">
                <h3>Aggiungi Cliente</h3>
                <div class="form-group">
                    <label for="client-name">Nome:</label>
                    <input type="text" id="client-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="client-email">Email:</label>
                    <input type="email" id="client-email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="client-phone">Telefono:</label>
                    <input type="tel" id="client-phone" name="phone" required>
                </div>
                <button type="submit" class="btn">Aggiungi Cliente</button>
            </form>
            <table id="clienti-table" class="dashboard-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Telefono</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Clienti caricati dinamicamente -->
                </tbody>
            </table>
        </section>

        <!-- Gestione Appuntamenti -->
        <section id="appuntamenti" class="tab-content">
            <h2>Gestione Appuntamenti</h2>
            <form id="add-appointment-form" class="dashboard-form">
                <h3>Aggiungi Appuntamento</h3>
                <div class="form-group">
                    <label for="appointment-client-name">Nome Cliente:</label>
                    <input type="text" id="appointment-client-name" name="client_name" placeholder="Nome cliente (opzionale)">
                </div>
                <div class="form-group">
                    <label for="appointment-phone">Telefono:</label>
                    <input type="tel" id="appointment-phone" name="phone" placeholder="Telefono (opzionale)">
                </div>
                <div class="form-group">
                    <label for="appointment-date">Data:</label>
                    <input type="date" id="appointment-date" name="date" required>
                </div>
                <div class="form-group">
                    <label for="appointment-time">Orario:</label>
                    <input type="time" id="appointment-time" name="time" required>
                </div>
                <div class="form-group">
                    <label for="appointment-notes">Note:</label>
                    <input type="text" id="appointment-notes" name="notes" placeholder="Note (opzionale)">
                </div>
                <button type="submit" class="btn">Aggiungi Appuntamento</button>
            </form>
            <table id="appuntamenti-table" class="dashboard-table">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Telefono</th>
                        <th>Data</th>
                        <th>Orario</th>
                        <th>Note</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Appuntamenti caricati dinamicamente -->
                </tbody>
            </table>
        </section>

        <!-- Gestione Trattamenti -->
        <section id="trattamenti" class="tab-content">
            <h2>Gestione Trattamenti</h2>
            <form id="add-treatment-form" class="dashboard-form">
                <h3>Aggiungi Trattamento</h3>
                <div class="form-group">
                    <label for="treatment-name">Nome Trattamento:</label>
                    <input type="text" id="treatment-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="treatment-description">Descrizione:</label>
                    <textarea id="treatment-description" name="description" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="treatment-price">Prezzo (€):</label>
                    <input type="number" id="treatment-price" name="price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="treatment-before-image">Immagine Prima (URL):</label>
                    <input type="url" id="treatment-before-image" name="before_image" required>
                </div>
                <div class="form-group">
                    <label for="treatment-after-image">Immagine Dopo (URL):</label>
                    <input type="url" id="treatment-after-image" name="after_image" required>
                </div>
                <button type="submit" class="btn">Aggiungi Trattamento</button>
            </form>
            <div class="service-grid">
                <table id="trattamenti-table" class="dashboard-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Descrizione</th>
                            <th>Prezzo</th>
                            <th>Immagine Prima</th>
                            <th>Immagine Dopo</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Trattamenti caricati dinamicamente -->
                    </tbody>
                </table>
            </div>

            <!-- Form di modifica trattamento (nascosto di default) -->
            <div id="edit-treatment-modal" class="modal">
                <div class="modal-content">
                    <h3>Modifica Trattamento</h3>
                    <form id="edit-treatment-form" class="dashboard-form">
                        <input type="hidden" id="edit-treatment-id">
                        <div class="form-group">
                            <label for="edit-treatment-name">Nome Trattamento:</label>
                            <input type="text" id="edit-treatment-name" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-treatment-description">Descrizione:</label>
                            <textarea id="edit-treatment-description" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-treatment-price">Prezzo (€):</label>
                            <input type="number" id="edit-treatment-price" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-treatment-before-image">Immagine Prima (URL):</label>
                            <input type="url" id="edit-treatment-before-image" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-treatment-after-image">Immagine Dopo (URL):</label>
                            <input type="url" id="edit-treatment-after-image" required>
                        </div>
                        <div class="modal-buttons">
                            <button type="submit" class="btn">Salva Modifiche</button>
                            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Annulla</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Gestione Sfondo -->
        <section id="background-section" class="tab-content">
            <h2>Gestione Sfondo</h2>
            <form id="background-form" class="dashboard-form">
                <label for="background-url">Inserisci l'URL dell'immagine di sfondo:</label>
                <input type="url" id="background-url" placeholder="https://example.com/image.jpg" required>
                <button type="submit">Aggiorna Sfondo</button>
            </form>
            <p id="background-message"></p>
            <!-- Nella sezione "Gestione Sfondo" puoi usare qualsiasi URL di immagine accessibile pubblicamente. -->
            <!-- I formati consigliati per lo sfondo sono: -->
            <!-- JPG/JPEG (consigliato per fotografie, buona compressione) -->
            <!-- PNG (consigliato per immagini con trasparenza, ma più pesante) -->
            <!-- WEBP (moderno, ottima qualità e compressione, ma non supportato da tutti i browser vecchi) -->
            <!-- Evita GIF e SVG per lo sfondo principale. -->
            <!-- L'URL deve terminare con .jpg, .jpeg, .png o .webp e deve essere accessibile senza autenticazione. -->
            <!-- Esempio valido: https://esempio.com/immagine.jpg -->
            <!-- Nella sezione "Gestione Sfondo" puoi usare qualsiasi URL di immagine accessibile pubblicamente.
                 Dimensioni consigliate per lo sfondo:
                 - Risoluzione consigliata: almeno 1920x1080 pixel (Full HD) per una buona resa su desktop.
                 - Rapporto consigliato: 16:9 oppure 4:3 (ma va bene anche verticale su mobile).
                 - Peso file: meglio sotto i 500 KB per velocità di caricamento.
                 - L'immagine verrà adattata a tutto lo schermo (background-size: cover), quindi evita scritte o dettagli importanti ai bordi.
                 - L'immagine deve essere accessibile senza autenticazione.
                 Esempio valido: https://esempio.com/immagine.jpg
            -->
        </section>

        <!-- Gestione Galleria -->
        <section id="gallery-section" class="tab-content">
            <h2>Gestione Galleria</h2>
            <form id="gallery-form" class="dashboard-form">
                <label for="gallery-image">Carica una nuova immagine per la galleria:</label>
                <input type="file" id="gallery-image" accept="image/*" required>
                <button type="submit">Carica Immagine</button>
            </form>
            <p id="gallery-message"></p>
            <div id="gallery-preview" class="gallery-preview">
                <!-- Immagini della galleria caricate dinamicamente -->
            </div>
        </section>

        <!-- Gestione Disponibilità -->
        <section id="disponibilita-section" class="tab-content">
            <h2>Gestione Disponibilità</h2>
            <form id="add-availability-form" class="dashboard-form">
                <h3>Aggiungi Disponibilità</h3>
                <div class="form-group">
                    <label for="availability-date">Data:</label>
                    <input type="date" id="availability-date" name="date" required>
                </div>
                <div class="form-group">
                    <label for="availability-time">Orario:</label>
                    <input type="time" id="availability-time" name="time" required>
                </div>
                <button type="submit" class="btn">Aggiungi Disponibilità</button>
            </form>
            <table id="disponibilita-table" class="dashboard-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Orario</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Disponibilità caricate dinamicamente -->
                </tbody>
            </table>
        </section>

        <script>
            const cloudinaryUrl = 'https://api.cloudinary.com/v1_1/dx9qj0kdb/image/upload';
            const uploadPreset = 'yzrzqskx'; // Nome del tuo upload preset configurato su Cloudinary

            // Funzione per caricare immagini su Cloudinary
            const uploadImageToCloudinary = async (file) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', uploadPreset);

                const response = await axios.post(cloudinaryUrl, formData);
                return response.data.secure_url;
            };

            // Gestione del caricamento dello sfondo
            document.getElementById('background-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                const backgroundUrl = document.getElementById('background-url').value;

                if (!backgroundUrl) {
                    document.getElementById('background-message').textContent = 'Inserisci un URL valido.';
                    return;
                }

                try {
                    // Salva l'URL dello sfondo su Supabase nella tabella settings
                    const { error } = await supabase
                        .from('settings')
                        .upsert([{ key: 'backgroundImage', value: backgroundUrl }], { onConflict: ['key'] });

                    if (error) {
                        console.error('Errore durante l\'aggiornamento dello sfondo:', error);
                        document.getElementById('background-message').textContent = 'Errore durante l\'aggiornamento dello sfondo.';
                        return;
                    }

                    document.getElementById('background-message').textContent = 'Sfondo aggiornato con successo!';
                    console.log('Nuovo URL dello sfondo salvato su Supabase:', backgroundUrl);
                } catch (error) {
                    console.error('Errore durante l\'aggiornamento dello sfondo:', error);
                    document.getElementById('background-message').textContent = 'Errore durante l\'aggiornamento dello sfondo.';
                }
            });

            // Gestione del caricamento delle immagini della galleria
            document.getElementById('gallery-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                const file = document.getElementById('gallery-image').files[0];

                if (!file) {
                    document.getElementById('gallery-message').textContent = 'Seleziona un file prima di caricare.';
                    return;
                }

                try {
                    const imageUrl = await uploadImageToCloudinary(file);
                    document.getElementById('gallery-message').textContent = 'Immagine caricata con successo!';
                    const galleryPreview = document.getElementById('gallery-preview');
                    galleryPreview.innerHTML += `
                        <div class="gallery-item">
                            <img src="${imageUrl}" alt="Galleria">
                        </div>
                    `;
                } catch (error) {
                    console.error('Errore durante il caricamento:', error.response?.data || error.message);
                    document.getElementById('gallery-message').textContent = 'Errore durante il caricamento.';
                }
            });

            // Funzione per cambiare tab
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
        </script>
        <script type="module" src="./js/dashboard.js"></script>
        <script type="module">
            import { supabase } from './js/supabaseClient.js';
            document.addEventListener('DOMContentLoaded', () => {
                const logoutBtn = document.getElementById('logout-button');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        try {
                            await supabase.auth.signOut();
                        } catch (err) {}
                        window.location.href = 'login.html';
                    });
                }
            });
        </script>
    </main>
    <footer class="dashboard-footer">
        <p>&copy; 2023 Sabrina Onicotecnica. Tutti i diritti riservati.</p>
    </footer>
</body>
</html>